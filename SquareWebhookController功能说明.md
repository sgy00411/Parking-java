# SquareWebhookController åŠŸèƒ½è¯´æ˜

## ğŸ“‹ æ¦‚è¿°

`SquareWebhookController` æ˜¯ä¸€ä¸ªç”¨äºæ¥æ”¶ Square æ”¯ä»˜å¹³å° Webhook äº‹ä»¶çš„æ§åˆ¶å™¨ï¼Œä¸»è¦è´Ÿè´£å¤„ç†åœ¨çº¿æ”¯ä»˜å’Œç»ˆç«¯POSæœºæ”¯ä»˜å®Œæˆåçš„å›è°ƒé€šçŸ¥ï¼Œå¹¶å°†æ”¯ä»˜æ•°æ®ä¿å­˜åˆ°æ•°æ®åº“ä¸­ã€‚

---

## ğŸ¯ ä¸»è¦åŠŸèƒ½

### 1. **æ¥æ”¶ Square Webhook äº‹ä»¶**

**æ¥å£åœ°å€**: `POST /api/payments/webhook`

**åŠŸèƒ½æè¿°**:
- æ¥æ”¶æ¥è‡ª Square æ”¯ä»˜å¹³å°çš„ Webhook é€šçŸ¥
- éªŒè¯è¯·æ±‚ç­¾åç¡®ä¿å®‰å…¨æ€§
- è§£ææ”¯ä»˜äº‹ä»¶æ•°æ®
- æ ¹æ®äº‹ä»¶ç±»å‹è°ƒç”¨ç›¸åº”çš„å¤„ç†é€»è¾‘
- å°†æ”¯ä»˜ä¿¡æ¯ä¿å­˜åˆ°æ•°æ®åº“

---

## ğŸ” å®‰å…¨éªŒè¯æœºåˆ¶

### ç­¾åéªŒè¯æµç¨‹

1. **æå–ç­¾å**: ä» HTTP Header `x-square-signature` ä¸­è·å– Square çš„ç­¾å
2. **åŠ¨æ€æ„å»º Webhook URL**:
   - ä»è¯·æ±‚ä¸­è‡ªåŠ¨è·å–åè®®ã€åŸŸåã€ç«¯å£ã€è·¯å¾„
   - ç”Ÿæˆå®Œæ•´çš„ Webhook URL (å¦‚: `https://car.test001.cn:8083/api/payments/webhook`)
3. **åŒé‡éªŒè¯**:
   - é¦–å…ˆä½¿ç”¨åŠ¨æ€æ„å»ºçš„ URL éªŒè¯ç­¾å
   - å¦‚æœå¤±è´¥ï¼Œä½¿ç”¨é…ç½®æ–‡ä»¶ä¸­çš„å¤‡ç”¨ URL å†æ¬¡éªŒè¯
4. **æ‹’ç»éæ³•è¯·æ±‚**: ç­¾åéªŒè¯å¤±è´¥åˆ™è¿”å› 401 çŠ¶æ€ç 

**é…ç½®é¡¹**:
```yaml
square:
  webhook:
    url: https://car.test001.cn:8083/api/payments/webhook
```

---

## ğŸ“¥ æ”¯æŒçš„äº‹ä»¶ç±»å‹

### 1. `payment.created` - æ”¯ä»˜åˆ›å»ºäº‹ä»¶

**è§¦å‘æ—¶æœº**:
- åœ¨çº¿æ”¯ä»˜: ç”¨æˆ·é€šè¿‡ç½‘é¡µ/APPå®Œæˆæ”¯ä»˜å
- ç»ˆç«¯æ”¯ä»˜: POSæœºåˆ·å¡å®Œæˆå

**å¤„ç†é€»è¾‘**:
1. æå–æ”¯ä»˜ID (`payment_id`)
2. æ£€æŸ¥æ•°æ®åº“æ˜¯å¦å·²å­˜åœ¨è¯¥æ”¯ä»˜è®°å½•
3. å¦‚æœå­˜åœ¨ï¼Œç›´æ¥è¿”å›ï¼ˆé¿å…é‡å¤ï¼‰
4. å¦‚æœä¸å­˜åœ¨ä½†æœ‰ `order_id`ï¼ŒæŸ¥æ‰¾æ˜¯å¦æ˜¯ç»ˆç«¯è®¢å•
5. æ‰¾åˆ°ç»ˆç«¯è®¢å•åˆ™æ›´æ–°ï¼Œå¦åˆ™åˆ›å»ºæ–°è®°å½•

### 2. `payment.updated` - æ”¯ä»˜æ›´æ–°äº‹ä»¶

**è§¦å‘æ—¶æœº**:
- æ”¯ä»˜çŠ¶æ€å‘ç”Ÿå˜åŒ–ï¼ˆå¦‚ä» PENDING å˜ä¸º COMPLETEDï¼‰
- æ”¯ä»˜é‡‘é¢å‘ç”Ÿè°ƒæ•´
- æ”¯ä»˜è¢«é€€æ¬¾

**å¤„ç†é€»è¾‘**:
1. æ ¹æ® `payment_id` æŸ¥æ‰¾ç°æœ‰è®°å½•
2. æ›´æ–°æ”¯ä»˜çŠ¶æ€ã€æ—¶é—´æˆ³ã€é‡‘é¢ç­‰ä¿¡æ¯
3. å¦‚æœè®°å½•ä¸å­˜åœ¨ï¼Œåˆ™ä½œä¸ºæ–°æ”¯ä»˜å¤„ç†

---

## ğŸ’¾ æ•°æ®ä¿å­˜é€»è¾‘

### PaymentOrder æ•°æ®åº“å­—æ®µåˆ†ç±»

#### åŸºæœ¬æ”¯ä»˜ä¿¡æ¯
- `square_payment_id` - Squareæ”¯ä»˜ID (å”¯ä¸€)
- `order_id` - Squareè®¢å•ID
- `location_id` - å•†æˆ·ä½ç½®ID
- `receipt_number` - æ”¶æ®çŸ­ç¼–å·
- `receipt_url` - ç”µå­æ”¶æ®é“¾æ¥
- `note` - å¤‡æ³¨ä¿¡æ¯

#### é‡‘é¢ä¿¡æ¯
- `amount` - æ”¯ä»˜é‡‘é¢ï¼ˆåˆ†ï¼Œå¦‚ 500 = $5.00ï¼‰
- `total_amount` - æ€»é‡‘é¢
- `approved_amount` - æ‰¹å‡†é‡‘é¢
- `currency` - è´§å¸ç±»å‹ (CAD/USD)

#### çŠ¶æ€ä¿¡æ¯
- `status` - æ”¯ä»˜çŠ¶æ€ (COMPLETED/PENDING/FAILED)
- `source_type` - æ”¯ä»˜æ¥æº (CARD/CASH/OTHER)
- `payment_source` - æ”¯ä»˜æ¸ é“ (ONLINE/TERMINAL/OTHER)

#### æ—¶é—´ä¿¡æ¯
- `created_at` - åˆ›å»ºæ—¶é—´
- `updated_at` - æ›´æ–°æ—¶é—´
- `authorized_at` - æˆæƒæ—¶é—´
- `captured_at` - èµ„é‡‘åˆ’è½¬æ—¶é—´

#### å¡ç‰‡ä¿¡æ¯
- `card_brand` - å¡å“ç‰Œ (VISA/MASTERCARD/AMEX)
- `last4` - å¡å·å4ä½
- `card_type` - å¡ç±»å‹ (CREDIT/DEBIT)
- `card_bin` - å¡ç‰‡BINç ï¼ˆå‰6ä½ï¼‰
- `card_exp_month` - è¿‡æœŸæœˆä»½
- `card_exp_year` - è¿‡æœŸå¹´ä»½
- `entry_method` - åˆ·å¡æ–¹å¼ (EMVèŠ¯ç‰‡/CONTACTLESSéæ¥è§¦)
- `cvv_status` - CVVéªŒè¯çŠ¶æ€
- `avs_status` - åœ°å€éªŒè¯çŠ¶æ€

#### ç»ˆç«¯æ”¯ä»˜ä¿¡æ¯
- `reference_id` - å‚è€ƒID
- `device_id` - ç»ˆç«¯è®¾å¤‡ID

#### é£é™©è¯„ä¼°
- `risk_level` - é£é™©ç­‰çº§ (NORMAL/MODERATE/HIGH)
- `risk_evaluation_created_at` - é£é™©è¯„ä¼°æ—¶é—´

#### åº”ç”¨ä¿¡æ¯
- `square_product` - Squareäº§å“ç±»å‹
- `application_id` - åº”ç”¨ID
- `version_token` - ç‰ˆæœ¬ä»¤ç‰Œ

---

## ğŸ”„ ä¸šåŠ¡æµç¨‹

### å®Œæ•´çš„æ”¯ä»˜æµç¨‹

```
1. ç”¨æˆ·å‘èµ·æ”¯ä»˜ï¼ˆåœ¨çº¿æˆ–POSæœºï¼‰
   â†“
2. Square å¤„ç†æ”¯ä»˜
   â†“
3. Square å‘é€ Webhook åˆ°æœåŠ¡å™¨
   â†“
4. SquareWebhookController æ¥æ”¶è¯·æ±‚
   â†“
5. éªŒè¯ç­¾åï¼ˆåŒé‡éªŒè¯æœºåˆ¶ï¼‰
   â†“
6. è§£æ JSON æ•°æ®
   â†“
7. åˆ¤æ–­äº‹ä»¶ç±»å‹ (payment.created / payment.updated)
   â†“
8. SquareWebhookService å¤„ç†ä¸šåŠ¡é€»è¾‘
   â†“
9. æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è®°å½•
   â†“
10. ä¿å­˜/æ›´æ–°åˆ°æ•°æ®åº“ (payment_orders è¡¨)
    â†“
11. è¿”å› 200 OK ç»™ Square
```

---

## ğŸ›¡ï¸ ç‰¹æ®Šå¤„ç†æœºåˆ¶

### 1. ç»ˆç«¯æ”¯ä»˜çš„æ™ºèƒ½è¯†åˆ«

**é—®é¢˜**: POSæœºæ”¯ä»˜æ—¶ï¼ŒSquare å¯èƒ½å…ˆåˆ›å»ºè®¢å•ï¼ˆåªæœ‰order_idï¼‰ï¼Œåç»­æ‰ç”Ÿæˆpayment_id

**è§£å†³æ–¹æ¡ˆ**:
```java
// 1. å…ˆæŒ‰ payment_id æŸ¥è¯¢
Optional<PaymentOrder> existing = paymentOrderRepository.findBySquarePaymentId(paymentId);

// 2. å¦‚æœæ²¡æ‰¾åˆ°ï¼ŒæŒ‰ order_id æŸ¥è¯¢ï¼ˆç»ˆç«¯è®¢å•ï¼‰
if (orderId != null) {
    Optional<PaymentOrder> terminalOrder = paymentOrderRepository.findByOrderId(orderId);
    if (terminalOrder.isPresent()) {
        // æ‰¾åˆ°äº†ï¼Œè¿™æ˜¯ç»ˆç«¯æ”¯ä»˜ï¼Œæ›´æ–°æ”¯ä»˜ä¿¡æ¯
        updatePaymentInfo(order, payment);
    }
}

// 3. éƒ½æ²¡æ‰¾åˆ°ï¼Œåˆ›å»ºæ–°è®°å½•ï¼ˆåœ¨çº¿æ”¯ä»˜ï¼‰
```

### 2. æ”¯ä»˜æ¥æºè‡ªåŠ¨åˆ¤æ–­

æ ¹æ®åˆ·å¡æ–¹å¼è‡ªåŠ¨åˆ¤æ–­ï¼š
- `EMV` (èŠ¯ç‰‡å¡) â†’ `TERMINAL` (ç»ˆç«¯æ”¯ä»˜)
- `CONTACTLESS` (éæ¥è§¦) â†’ `TERMINAL` (ç»ˆç«¯æ”¯ä»˜)
- å…¶ä»– â†’ `ONLINE` (åœ¨çº¿æ”¯ä»˜)

### 3. é˜²é‡å¤æœºåˆ¶

- å…ˆæŸ¥è¯¢ `square_payment_id` é¿å…é‡å¤åˆ›å»º
- å†æŸ¥è¯¢ `order_id` å…³è”ç»ˆç«¯è®¢å•
- ç¡®ä¿åŒä¸€ç¬”æ”¯ä»˜åªå…¥åº“ä¸€æ¬¡

### 4. å®¹é”™å¤„ç†

å³ä½¿å¤„ç†å¤±è´¥ï¼Œä¹Ÿè¿”å› 200 OKï¼Œé¿å… Square æ— é™é‡è¯•ï¼š
```java
catch (Exception e) {
    log.error("å¤„ç†å¤±è´¥", e);
    // è¿”å› 200 ä½†è®°å½•é”™è¯¯ä¿¡æ¯
    return ResponseEntity.ok("Webhook received but processing failed");
}
```

---

## ğŸ“Š æ—¥å¿—è¾“å‡º

### è¯¦ç»†çš„æ—¥å¿—è®°å½•

```
=================================================================
æ”¶åˆ° Square Webhook äº‹ä»¶ - æ—¶é—´: 2025-11-30 20:00:00
=================================================================
ğŸ“ åŠ¨æ€æ„å»ºçš„ Webhook URL: https://car.test001.cn:8083/api/payments/webhook
ğŸ“ é…ç½®æ–‡ä»¶ä¸­çš„ URL: https://car.test001.cn:8083/api/payments/webhook
ğŸ“ æ”¶åˆ°ç­¾å: r3x8B5...
âœ… ç­¾åéªŒè¯æˆåŠŸ
å•†æˆ· ID: ML5T...
äº‹ä»¶ç±»å‹: payment.created
äº‹ä»¶ ID: 8d3f...
åˆ›å»ºæ—¶é—´: 2025-11-30T12:00:00Z
ğŸ“ å¤„ç†æ”¯ä»˜åˆ›å»ºäº‹ä»¶
âœ… æˆåŠŸä¿å­˜æ”¯ä»˜è®°å½•: ID=abc123, Amount=500 CAD
ğŸ’¾ æ•°æ®åº“è®°å½• ID: 123
-----------------------------------------------------------------
å®Œæ•´ Webhook æ•°æ®:
{
  "merchant_id" : "...",
  "type" : "payment.created",
  "data" : { ... }
}
=================================================================
```

---

## ğŸ§ª å¥åº·æ£€æŸ¥

### æ¥å£

**åœ°å€**: `GET /api/payments/webhook/health`

**å“åº”**:
```json
{
  "status": "Webhook endpoint is running"
}
```

**ç”¨é€”**:
- éªŒè¯ Webhook æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ
- Square Dashboard æµ‹è¯•è¿æ¥æ—¶ä½¿ç”¨

---

## ğŸ’¡ ä½¿ç”¨åœºæ™¯

### åœºæ™¯1: åœ¨çº¿æ”¯ä»˜

1. ç”¨æˆ·åœ¨ç½‘é¡µä¸Šè¾“å…¥ä¿¡ç”¨å¡ä¿¡æ¯
2. Square å¤„ç†æ”¯ä»˜
3. Webhook å‘é€ `payment.created` äº‹ä»¶
4. ç³»ç»Ÿåˆ›å»ºæ–°çš„ `PaymentOrder` è®°å½•
5. ç”¨æˆ·æ”¶åˆ°æ”¯ä»˜ç¡®è®¤é‚®ä»¶

### åœºæ™¯2: POSæœºåˆ·å¡

1. æ”¶é“¶å‘˜åœ¨POSæœºä¸Šè¾“å…¥é‡‘é¢
2. é¡¾å®¢åˆ·å¡/æ’å¡/éæ¥è§¦æ”¯ä»˜
3. Square å…ˆå‘é€ `payment.created` (å¯èƒ½åªæœ‰ order_id)
4. ç³»ç»Ÿåˆ›å»ºä¸´æ—¶è®¢å•
5. Square å†å‘é€å®Œæ•´çš„ `payment.created` (åŒ…å« payment_id)
6. ç³»ç»Ÿæ›´æ–°è®¢å•ï¼Œè¡¥å……æ”¯ä»˜è¯¦æƒ…
7. æ‰“å°æ”¶æ®

### åœºæ™¯3: æ”¯ä»˜çŠ¶æ€å˜åŒ–

1. æ”¯ä»˜åˆå§‹çŠ¶æ€ä¸º PENDING
2. é“¶è¡Œå®Œæˆæˆæƒ
3. Square å‘é€ `payment.updated` äº‹ä»¶
4. ç³»ç»Ÿæ›´æ–°çŠ¶æ€ä¸º COMPLETED
5. è§¦å‘å‘è´§æµç¨‹

---

## ğŸ”§ é…ç½®è¦æ±‚

### application.yml é…ç½®

```yaml
square:
  webhook:
    url: https://car.test001.cn:8083/api/payments/webhook
  signature-key: your-signature-key  # Square æä¾›çš„ç­¾åå¯†é’¥
```

### Square Dashboard é…ç½®

1. ç™»å½• Square Dashboard
2. è¿›å…¥ Developer â†’ Webhooks
3. æ·»åŠ  Webhook URL: `https://car.test001.cn:8083/api/payments/webhook`
4. è®¢é˜…äº‹ä»¶:
   - `payment.created`
   - `payment.updated`
5. ä¿å­˜ç­¾åå¯†é’¥åˆ°é…ç½®æ–‡ä»¶

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å¿…é¡»ä½¿ç”¨ HTTPS**: Square è¦æ±‚ Webhook URL å¿…é¡»æ˜¯ HTTPS
2. **ç­¾åéªŒè¯**: ç”Ÿäº§ç¯å¢ƒåŠ¡å¿…å¼€å¯ç­¾åéªŒè¯
3. **å¹‚ç­‰æ€§**: åŒä¸€ä¸ª payment_id å¯èƒ½æ”¶åˆ°å¤šæ¬¡é€šçŸ¥ï¼Œéœ€é˜²é‡å¤
4. **å¼‚æ­¥å¤„ç†**: Webhook å¤„ç†åº”å¿«é€Ÿå“åº”ï¼ˆ< 10ç§’ï¼‰ï¼Œé¿å…è¶…æ—¶
5. **æ—¥å¿—ä¿ç•™**: å®Œæ•´ä¿å­˜ Webhook JSON æ•°æ®ï¼Œä¾¿äºæ’æŸ¥é—®é¢˜
6. **é”™è¯¯å¤„ç†**: å³ä½¿å¤±è´¥ä¹Ÿè¿”å› 200ï¼Œé¿å… Square é‡è¯•é£æš´

---

## ğŸ“ˆ æ•°æ®åº“è¡¨ç»“æ„

```sql
CREATE TABLE payment_orders (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    square_payment_id VARCHAR(255) UNIQUE,
    order_id VARCHAR(255),
    amount BIGINT,
    currency VARCHAR(10),
    status VARCHAR(50),
    card_brand VARCHAR(50),
    last4 VARCHAR(4),
    payment_source VARCHAR(20),
    created_at TIMESTAMP,
    updated_at TIMESTAMP,
    -- ... æ›´å¤šå­—æ®µ
);
```

**ç´¢å¼•å»ºè®®**:
- `square_payment_id` (å”¯ä¸€ç´¢å¼•)
- `order_id` (æ™®é€šç´¢å¼•ï¼Œç”¨äºç»ˆç«¯è®¢å•æŸ¥è¯¢)
- `status` (æ™®é€šç´¢å¼•ï¼Œç”¨äºçŠ¶æ€ç­›é€‰)
- `created_at` (æ™®é€šç´¢å¼•ï¼Œç”¨äºæ—¶é—´èŒƒå›´æŸ¥è¯¢)

---

## ğŸ“ æ€»ç»“

`SquareWebhookController` å®ç°äº†ä¸€ä¸ªå®Œæ•´ã€å¥å£®çš„æ”¯ä»˜å›è°ƒå¤„ç†ç³»ç»Ÿï¼š

âœ… **å®‰å…¨**: åŒé‡ç­¾åéªŒè¯æœºåˆ¶
âœ… **æ™ºèƒ½**: è‡ªåŠ¨è¯†åˆ«åœ¨çº¿/ç»ˆç«¯æ”¯ä»˜
âœ… **é˜²é‡**: é¿å…é‡å¤å…¥åº“
âœ… **å®¹é”™**: å¤„ç†å¤±è´¥ä¸å½±å“ Square
âœ… **è¯¦ç»†**: å®Œæ•´çš„æ—¥å¿—è®°å½•
âœ… **å¯é **: äº‹åŠ¡ä¿è¯æ•°æ®ä¸€è‡´æ€§

è¿™æ˜¯ä¸€ä¸ªç”Ÿäº§çº§çš„æ”¯ä»˜ Webhook å¤„ç†æ–¹æ¡ˆï¼
