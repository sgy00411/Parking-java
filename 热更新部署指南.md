# å‰åç«¯çƒ­æ›´æ–°éƒ¨ç½²æŒ‡å—

## ğŸ“‹ ç³»ç»Ÿæ¶æ„

```
ç”¨æˆ·è®¿é—®: https://test001.cn (HTTPS 443)
           â†“
        Nginx åå‘ä»£ç†
           â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â†“                     â†“
å‰ç«¯è½¯é“¾æ¥åˆ‡æ¢         åç«¯Upstreamè´Ÿè½½å‡è¡¡
    â†“                     â†“
dist-8081 â‡„ dist-8082  8086 â‡„ 8087
```

---

## ğŸš€ ä¸€ã€å‰ç«¯çƒ­æ›´æ–°

### ç›®å½•ç»“æ„
```
/www/wwwroot/Parking-vue/
â”œâ”€â”€ dist -> dist-8081      # è½¯é“¾æ¥æŒ‡å‘å½“å‰ç‰ˆæœ¬
â”œâ”€â”€ dist-8081/             # ç‰ˆæœ¬1ï¼ˆå½“å‰ï¼‰
â”œâ”€â”€ dist-8082/             # ç‰ˆæœ¬2ï¼ˆå¤‡ç”¨ï¼‰
â”œâ”€â”€ src/                   # æºä»£ç 
â””â”€â”€ deploy-frontend.sh     # çƒ­æ›´æ–°è„šæœ¬
```

### æ›´æ–°æ­¥éª¤

#### æ–¹å¼1ï¼šä½¿ç”¨ä¸€é”®è„šæœ¬ï¼ˆæ¨èï¼‰

```bash
cd /www/wwwroot/Parking-vue
./deploy-frontend.sh
```

è„šæœ¬ä¼šè‡ªåŠ¨ï¼š
1. æ£€æµ‹å½“å‰ç‰ˆæœ¬ï¼ˆ8081/8082ï¼‰
2. æ„å»ºæ–°ç‰ˆæœ¬ `npm run build`
3. éƒ¨ç½²åˆ°å¤‡ç”¨ç›®å½•
4. åˆ‡æ¢è½¯é“¾æ¥
5. é‡è½½nginx

#### æ–¹å¼2ï¼šæ‰‹åŠ¨éƒ¨ç½²

```bash
cd /www/wwwroot/Parking-vue

# 1. æ‹‰å–ä»£ç 
git pull

# 2. å®‰è£…ä¾èµ–ï¼ˆå¦‚æœpackage.jsonæœ‰å˜åŒ–ï¼‰
npm install

# 3. æ„å»º
npm run build

# 4. æ£€æŸ¥å½“å‰ç‰ˆæœ¬
ls -l dist  # æŸ¥çœ‹è½¯é“¾æ¥æŒ‡å‘

# 5. éƒ¨ç½²åˆ°å¤‡ç”¨ç›®å½•
# å¦‚æœå½“å‰æ˜¯dist-8081ï¼Œåˆ™éƒ¨ç½²åˆ°dist-8082
rm -rf dist-8082/*
cp -r dist/* dist-8082/

# 6. åˆ‡æ¢è½¯é“¾æ¥ï¼ˆåŸå­æ“ä½œï¼‰
ln -snf dist-8082 dist

# 7. é‡è½½nginx
nginx -t && nginx -s reload
```

### å›æ»šæ“ä½œ

```bash
cd /www/wwwroot/Parking-vue

# åˆ‡æ¢å›æ—§ç‰ˆæœ¬
ln -snf dist-8081 dist

# é‡è½½nginx
nginx -s reload
```

---

## ğŸ”§ äºŒã€åç«¯çƒ­æ›´æ–°

### é…ç½®æ–‡ä»¶
```
/www/wwwroot/Parking-java/
â”œâ”€â”€ src/main/resources/
â”‚   â”œâ”€â”€ application.yml        # 8086é…ç½®
â”‚   â””â”€â”€ application-8087.yml   # 8087é…ç½®
â”œâ”€â”€ target/
â”‚   â””â”€â”€ quaer_api-0.0.1-SNAPSHOT.jar
â””â”€â”€ deploy-backend.sh          # çƒ­æ›´æ–°è„šæœ¬
```

### å…³é”®é…ç½®å·®å¼‚

**application.yml (8086)**
```yaml
server:
  port: 8086

mqtt:
  client-id: parking_server
  subscribe-topics:
    - $share/parking-group/parking/#  # å…±äº«è®¢é˜…ï¼Œé¿å…é‡å¤æ¶ˆè´¹
```

**application-8087.yml (8087)**
```yaml
server:
  port: 8087

mqtt:
  client-id: parking_server_8087  # å¿…é¡»ä¸åŒï¼Œé¿å…MQTTè¿æ¥å†²çª
  subscribe-topics:
    - $share/parking-group/parking/#  # å…±äº«è®¢é˜…ï¼Œé¿å…é‡å¤æ¶ˆè´¹
```

### æ›´æ–°æ­¥éª¤

#### æ–¹å¼1ï¼šä½¿ç”¨ä¸€é”®è„šæœ¬ï¼ˆæ¨èï¼‰

```bash
cd /www/wwwroot/Parking-java
./deploy-backend.sh
```

è„šæœ¬ä¼šè‡ªåŠ¨ï¼š
1. æ£€æµ‹å½“å‰ä¸»æœåŠ¡ç«¯å£
2. æ„å»ºæ–°ç‰ˆæœ¬ `mvn clean package`
3. åœæ­¢å¤‡ç”¨ç«¯å£æ—§æœåŠ¡
4. å¯åŠ¨æ–°æœåŠ¡
5. å¥åº·æ£€æŸ¥
6. åˆ‡æ¢nginxæµé‡
7. åœæ­¢æ—§æœåŠ¡

#### æ–¹å¼2ï¼šæ‰‹åŠ¨éƒ¨ç½²

```bash
cd /www/wwwroot/Parking-java

# 1. æ‹‰å–ä»£ç 
git pull

# 2. æ„å»º
mvn clean package -DskipTests

# 3. æ£€æŸ¥å½“å‰ä¸»æœåŠ¡
netstat -tlnp | grep java
# å‡è®¾8086æ˜¯ä¸»æœåŠ¡

# 4. å¯åŠ¨8087
nohup java -jar target/quaer_api-0.0.1-SNAPSHOT.jar \
  --spring.config.location=classpath:/application-8087.yml \
  > logs/app-8087.log 2>&1 &

# 5. ç­‰å¾…å¯åŠ¨å¹¶æ£€æŸ¥
sleep 10
netstat -tlnp | grep 8087
tail -f logs/app-8087.log

# 6. ä¿®æ”¹nginxé…ç½®
vim /www/server/panel/vhost/nginx/122.51.64.122.conf

# ä¿®æ”¹upstreamé…ç½®ï¼š
# server 127.0.0.1:8086 down max_fails=3 fail_timeout=30s;
# server 127.0.0.1:8087 weight=1 max_fails=3 fail_timeout=30s;

# 7. é‡è½½nginx
nginx -t && nginx -s reload

# 8. ç­‰å¾…æ—§æœåŠ¡å¤„ç†å®Œè¯·æ±‚
sleep 10

# 9. åœæ­¢8086
kill -15 $(lsof -ti:8086)
```

### å›æ»šæ“ä½œ

```bash
# 1. é‡æ–°å¯åŠ¨æ—§ç«¯å£
cd /www/wwwroot/Parking-java
nohup java -jar target/quaer_api-0.0.1-SNAPSHOT.jar \
  > logs/app-8086.log 2>&1 &

# 2. ä¿®æ”¹nginxé…ç½®åˆ‡æ¢å›8086
vim /www/server/panel/vhost/nginx/122.51.64.122.conf
# æ”¹ä¸ºï¼š
# server 127.0.0.1:8086 weight=1 max_fails=3 fail_timeout=30s;
# server 127.0.0.1:8087 down max_fails=3 fail_timeout=30s;

# 3. é‡è½½nginx
nginx -s reload

# 4. åœæ­¢8087
kill -15 $(lsof -ti:8087)
```

---

## ğŸ“Š ä¸‰ã€çŠ¶æ€æ£€æŸ¥

### æ£€æŸ¥å‰ç«¯ç‰ˆæœ¬
```bash
ls -l /www/wwwroot/Parking-vue/dist
# è¾“å‡º: dist -> dist-8081  æˆ–  dist -> dist-8082
```

### æ£€æŸ¥åç«¯æœåŠ¡
```bash
# æŸ¥çœ‹Javaè¿›ç¨‹
netstat -tlnp | grep java

# æŸ¥çœ‹nginxé…ç½®
grep -A 10 "upstream backend_app" /www/server/panel/vhost/nginx/122.51.64.122.conf

# æŸ¥çœ‹æ—¥å¿—
tail -f /www/wwwroot/Parking-java/logs/app-8086.log
tail -f /www/wwwroot/Parking-java/logs/app-8087.log
```

### æµ‹è¯•æœåŠ¡
```bash
# æµ‹è¯•å‰ç«¯
curl -I https://test001.cn

# æµ‹è¯•åç«¯API
curl https://test001.cn/api/health  # å¦‚æœæœ‰å¥åº·æ£€æŸ¥æ¥å£
```

---

## âš ï¸ å››ã€æ³¨æ„äº‹é¡¹

### å‰ç«¯æ³¨æ„äº‹é¡¹
1. **ç¼“å­˜é—®é¢˜**ï¼šç¡®ä¿åœ¨æ„å»ºæ—¶è®¾ç½®æ­£ç¡®çš„ç‰ˆæœ¬å·æˆ–hashï¼Œé¿å…æµè§ˆå™¨ç¼“å­˜
2. **é™æ€èµ„æº**ï¼šè½¯é“¾æ¥åˆ‡æ¢æ˜¯åŸå­æ“ä½œï¼Œä¸ä¼šå‡ºç°èµ„æºæ··ä¹±
3. **æ„å»ºå¤±è´¥**ï¼šè„šæœ¬ä¼šè‡ªåŠ¨æ£€æµ‹ï¼Œä¸ä¼šåˆ‡æ¢åˆ°é”™è¯¯ç‰ˆæœ¬

### åç«¯æ³¨æ„äº‹é¡¹
1. **MQTTå…±äº«è®¢é˜…**ï¼šä¸¤ä¸ªå®ä¾‹ä½¿ç”¨ `$share/parking-group/parking/#` å…±äº«è®¢é˜…ï¼Œæ¶ˆæ¯åªä¼šå‘ç»™å…¶ä¸­ä¸€ä¸ªå®ä¾‹ï¼Œé¿å…é‡å¤å¤„ç†
2. **MQTTå®¢æˆ·ç«¯ID**ï¼šä¸¤ä¸ªå®ä¾‹çš„`mqtt.client-id`å¿…é¡»ä¸åŒï¼Œé¿å…è¿æ¥å†²çª
3. **æ•°æ®åº“è¿æ¥**ï¼šå…±ç”¨åŒä¸€ä¸ªæ•°æ®åº“ï¼Œæ³¨æ„å¹¶å‘
4. **å¥åº·æ£€æŸ¥**ï¼šç¡®ä¿æ–°æœåŠ¡å®Œå…¨å¯åŠ¨åå†åˆ‡æ¢æµé‡
5. **ä¼šè¯ä¿æŒ**ï¼šnginxé…ç½®äº†`keepalive`ï¼Œä¿æŒè¿æ¥ç¨³å®š
6. **ç«¯å£å ç”¨**ï¼šéƒ¨ç½²å‰ç¡®ä¿ç›®æ ‡ç«¯å£æ²¡æœ‰æ—§è¿›ç¨‹

### é€šç”¨æ³¨æ„äº‹é¡¹
1. **å¤‡ä»½**ï¼šè„šæœ¬ä¼šè‡ªåŠ¨å¤‡ä»½nginxé…ç½®
2. **æ—¥å¿—**ï¼šæ‰€æœ‰æ“ä½œéƒ½æœ‰è¯¦ç»†æ—¥å¿—è®°å½•
3. **å›æ»š**ï¼šä¿ç•™æ—§ç‰ˆæœ¬ï¼Œæ”¯æŒå¿«é€Ÿå›æ»š
4. **æµ‹è¯•**ï¼šå…ˆåœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯ï¼Œå†ç”Ÿäº§éƒ¨ç½²

---

## ğŸ” äº”ã€å¸¸è§é—®é¢˜

### Q1: å‰ç«¯æ›´æ–°åä»æ˜¾ç¤ºæ—§ç‰ˆæœ¬ï¼Ÿ
A: æµè§ˆå™¨ç¼“å­˜é—®é¢˜ï¼Œæ¸…é™¤ç¼“å­˜æˆ–å¼ºåˆ¶åˆ·æ–°ï¼ˆCtrl+F5ï¼‰

### Q2: åç«¯åˆ‡æ¢å¤±è´¥ï¼Ÿ
A: æ£€æŸ¥æ–°æœåŠ¡æ˜¯å¦æ­£å¸¸å¯åŠ¨ï¼š
```bash
netstat -tlnp | grep 8087
tail -f logs/app-8087.log
```

### Q3: nginxé…ç½®æµ‹è¯•å¤±è´¥ï¼Ÿ
A: è„šæœ¬ä¼šè‡ªåŠ¨å›æ»šé…ç½®ï¼Œæ£€æŸ¥è¯­æ³•é”™è¯¯ï¼š
```bash
nginx -t
```

### Q4: ä¸¤ä¸ªåç«¯å®ä¾‹åŒæ—¶è¿è¡Œæ—¶ï¼ŒMQTTæ¶ˆæ¯ä¼šé‡å¤å¤„ç†å—ï¼Ÿ
A: **ä¸ä¼š**ã€‚æˆ‘ä»¬ä½¿ç”¨äº†EMQXçš„**å…±äº«è®¢é˜…**åŠŸèƒ½ `$share/parking-group/parking/#`ï¼ŒåŒä¸€æ¡æ¶ˆæ¯åªä¼šå‘ç»™å…¶ä¸­ä¸€ä¸ªå®ä¾‹ï¼Œä¸ä¼šé‡å¤å¤„ç†ã€‚ä¸¤ä¸ªå®ä¾‹ç»„æˆä¸€ä¸ªè®¢é˜…ç»„ï¼ŒEMQXä¼šè‡ªåŠ¨è´Ÿè½½å‡è¡¡åˆ†å‘æ¶ˆæ¯ã€‚

### Q5: å¦‚ä½•æŸ¥çœ‹éƒ¨ç½²å†å²ï¼Ÿ
A: æŸ¥çœ‹nginxé…ç½®å¤‡ä»½ï¼š
```bash
ls -lh /www/server/panel/vhost/nginx/122.51.64.122.conf.backup-*
```

---

## ğŸ“ å…­ã€ç´§æ€¥æƒ…å†µå¤„ç†

### æœåŠ¡å®Œå…¨å®•æœº
```bash
# 1. æ£€æŸ¥nginx
systemctl status nginx
nginx -t

# 2. æ£€æŸ¥åç«¯
netstat -tlnp | grep java

# 3. é‡å¯æœåŠ¡
cd /www/wwwroot/Parking-java
nohup java -jar target/quaer_api-0.0.1-SNAPSHOT.jar > logs/app.log 2>&1 &

# 4. é‡å¯nginx
nginx -s reload
```

### å›æ»šåˆ°æœ€åçš„ç¨³å®šç‰ˆæœ¬
```bash
# å‰ç«¯
cd /www/wwwroot/Parking-vue
ln -snf dist-8081 dist  # æˆ– dist-8082
nginx -s reload

# åç«¯
# æ¢å¤nginxé…ç½®å¤‡ä»½
cp /www/server/panel/vhost/nginx/122.51.64.122.conf.backup-XXXXXX \
   /www/server/panel/vhost/nginx/122.51.64.122.conf
nginx -s reload
```

---

## ğŸ“ ä¸ƒã€æ›´æ–°æ—¥å¿—æ¨¡æ¿

å»ºè®®æ¯æ¬¡éƒ¨ç½²åè®°å½•ï¼š

```
æ—¥æœŸï¼š2025-XX-XX
æ›´æ–°ç±»å‹ï¼šå‰ç«¯/åç«¯
ç‰ˆæœ¬ï¼šdist-8081/8082 æˆ– 8086/8087
æ›´æ–°å†…å®¹ï¼š
- åŠŸèƒ½1
- åŠŸèƒ½2
- Bugä¿®å¤

éƒ¨ç½²äººå‘˜ï¼š
å¤‡æ³¨ï¼š
```

---

**æœ€åæ›´æ–°ï¼š2025-12-28**
